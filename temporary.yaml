---
# A list of variables that must be set for all elements
preamble:
    LC_ALL: POSIX
    WANDER: /mnt/wander
    PATH: /tools/bin:/bin:/usr/bin
    WANDER_TGT: '{arch}-wander-linux-gnu'
#     LDFLAGS = --sysroot=$WANDER
# The user that must run this section
user: wander
# The elements, each representing one unit to execute
elements:
    binutils_1:
        description: Binutils (Pass 1)
        version: 2.32
        file: binutils-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/binutils/
        md5: 0d174cdaf85721c5723bf52355be41e6
        folder: build
        commands:
            preparation:
                - ../configure --prefix=/tools
                               --with-sysroot=$WANDER
                               --with-lib-path=/tools/lib
                               --target=$WANDER_TGT
                               --disable-nls
                               --disable-werror
            compilation:
                - make
            configuration:
                - case $(uname -m) in
                    x86_64) mkdir -v /tools/lib && ln -sv lib /tools/lib64 ;;
                  esac
            installation:
                - make install
    gcc_1:
        description: GCC (Pass 1)
        version: 9.2.0
        file: gcc-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/gcc/gcc-{version}/
        md5: 3818ad8600447f05349098232c2ddc78
        modules:
            mpfr:
                description: MPFR
                version: 4.0.2
                file: mpfr-{version}
                extension: .tar.xz
                url: http://www.mpfr.org/mpfr-{version}
                md5: 320fbc4463d4c8cb1e566929d8adc4f8
                folder: mpfr
            gmp:
                description: GMP
                version: 6.1.2
                file: gmp-{version}
                extension: .tar.xz
                url: http://ftp.gnu.org/gnu/gmp/
                md5: f58fa8001d60c4c77595fbbb62b63c1d
                folder: gmp
            mpc:
                description: MPC
                version: 1.1.0
                file: mpc-{version}
                extension: .tar.gz
                url: http://ftp.gnu.org/gnu/mpc/
                md5: 4125404e41e482ec68282a2e687f6c73
                folder: mpc
        folder: build
        commands:
            setup:
                - for file in gcc/config/{linux,i386/linux{,64}}.h;
                  do (
                    cp -uv $file{,.orig};
                    sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&@g'
                        -e 's@/usr@/tools@g' $file.orig > $file;
                    printf '#undef STANDARD_STARTFILE_PREFIX_1\n#undef STANDARD_STARTFILE_PREFIX_2\n#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"\n#define STANDARD_STARTFILE_PREFIX_2 ""\n' >> $file;
                    touch $file.orig);
                  done
                - case $(uname -m) in
                    x86_64) sed -e '/m64=/s/lib64/lib/'
                                -i.orig gcc/config/i386/t-linux64
                    ;;
                  esac
            preparation:
                - ../configure --target=$WANDER_TGT
                               --prefix=/tools
                               --with-glibc-version=2.11
                               --with-sysroot=$WANDER
                               --with-newlib
                               --without-headers
                               --with-local-prefix=/tools
                               --with-native-system-header-dir=/tools/include
                               --disable-nls
                               --disable-shared
                               --disable-multilib
                               --disable-decimal-float
                               --disable-threads
                               --disable-libatomic
                               --disable-libgomp
                               --disable-libquadmath
                               --disable-libssp
                               --disable-libvtv
                               --disable-libstdcxx
                               --enable-languages=c,c++
            compilation:
                - make
            installation:
                - make install
    linux:
        description: Linux API Headers
        version: 5.2.8
        file: linux-{version}
        extension: .tar.xz
        url: http://www.kernel.org/pub/linux/kernel/v5.x/
        md5: 602dd0ecb8646e539fefb2beb6eb6fe0
        commands:
            preparation:
                - make mrproper
            installation:
                - make INSTALL_HDR_PATH=dest headers_install
                - cp -rv dest/include/* /tools/include
    glibc:
        description: Glibc
        version: '2.30'
        file: glibc-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/glibc/
        md5: 2b1dbdf27b28620752956c061d62f60c
        folder: build
        commands:
            preparation:
                - ../configure --prefix=/tools
                               --host=$WANDER_TGT
                               --build=$(../scripts/config.guess)
                               --enable-kernel=3.2
                               --with-headers=/tools/include
            compilation:
                - make
            installation:
                - make install
            validation:
                - echo 'int main(){}' > dummy.c
                - $WANDER_TGT-gcc dummy.c
                - "readelf -l a.out | grep ': /tools'"
            cleanup:
                - rm -v dummy.c a.out
        result:
            - "[Requesting program interpreter: /tools/lib64/ld-linux-x86-64.so.2]"
            - "[Requesting program interpreter: /tools/lib/ld-linux.so.2]"
    libstdc++:
        description: Libstdc++ (from GCC)
        version: 9.2.0
        file: gcc-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/gcc/gcc-{version}/
        md5: 3818ad8600447f05349098232c2ddc78
        folder: build
        commands:
            preparation:
                - ../libstdc++-v3/configure --host=$WANDER_TGT
                                            --prefix=/tools
                                            --disable-multilib
                                            --disable-nls
                                            --disable-libstdcxx-threads
                                            --disable-libstdcxx-pch
                                            --with-gxx-include-dir=/tools/$WANDER_TGT/include/c++/9.2.0
            compilation:
                - make
            installation:
                - make install
    binutils_2:
        description: Binutils (Pass 2)
        version: 2.32
        file: binutils-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/binutils/
        md5: 0d174cdaf85721c5723bf52355be41e6
        folder: build
        commands:
            preparation:
                - CC=$WANDER_TGT-gcc
                  AR=$WANDER_TGT-ar
                  RANLIB=$WANDER_TGT-ranlib
                  ../configure --prefix=/tools
                               --disable-nls
                               --disable-werror
                               --with-lib-path=/tools/lib
                               --with-sysroot
            compilation:
                - make
            installation:
                - make install
                - make -C ld clean
                - "make -C ld LIB_PATH=/usr/lib:/lib"
                - cp -v ld/ld-new /tools/bin
    gcc_2:
        description: GCC (Pass 2)
        version: 9.2.0
        file: gcc-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/gcc/gcc-{version}/
        md5: 3818ad8600447f05349098232c2ddc78
        modules:
            mpfr:
                description: MPFR
                version: 4.0.2
                file: mpfr-{version}
                extension: .tar.xz
                url: http://www.mpfr.org/mpfr-{version}
                md5: 320fbc4463d4c8cb1e566929d8adc4f8
                folder: mpfr
            gmp:
                description: GMP
                version: 6.1.2
                file: gmp-{version}
                extension: .tar.xz
                url: http://ftp.gnu.org/gnu/gmp/
                md5: f58fa8001d60c4c77595fbbb62b63c1d
                folder: gmp
            mpc:
                description: MPC
                version: 1.1.0
                file: mpc-{version}
                extension: .tar.gz
                url: http://ftp.gnu.org/gnu/mpc/
                md5: 4125404e41e482ec68282a2e687f6c73
                folder: mpc
        folder: build
        commands:
            setup:
                - cat gcc/limitx.h gcc/glimits.h gcc/limity.h >
                    `dirname $($WANDER_TGT-gcc -print-libgcc-file-name)`/include-fixed/limits.h
                - for file in gcc/config/{linux,i386/linux{,64}}.h;
                  do (
                    cp -uv $file{,.orig};
                    sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&@g'
                        -e 's@/usr@/tools@g' $file.orig > $file;
                    printf '#undef STANDARD_STARTFILE_PREFIX_1\n#undef STANDARD_STARTFILE_PREFIX_2\n#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"\n#define STANDARD_STARTFILE_PREFIX_2 ""' >> $file;
                    touch $file.orig);
                  done
                - case $(uname -m) in
                    x86_64) sed -e '/m64=/s/lib64/lib/'
                                -i.orig gcc/config/i386/t-linux64
                    ;;
                  esac
            preparation:
                - CC=$WANDER_TGT-gcc
                  CXX=$WANDER_TGT-g++
                  AR=$WANDER_TGT-ar
                  RANLIB=$WANDER_TGT-ranlib
                  ../configure --prefix=/tools
                               --with-local-prefix=/tools
                               --with-native-system-header-dir=/tools/include
                               --enable-languages=c,c++
                               --disable-libstdcxx-pch
                               --disable-multilib
                               --disable-bootstrap
                               --disable-libgomp
            compilation:
                - make
            installation:
                - make install
                - ln -sv gcc /tools/bin/cc
            validation:
                - echo 'int main(){}' > dummy.c
                - cc dummy.c
                - "readelf -l a.out | grep ': /tools'"
            cleanup:
                - rm -v dummy.c a.out
        result:
            - "[Requesting program interpreter: /tools/lib64/ld-linux-x86-64.so.2]"
            - "[Requesting program interpreter: /tools/lib/ld-linux.so.2]"
    tcl:
        description: Tcl
        version: 8.6.9
        file: tcl{version}-src
        extension: .tar.gz
        url: https://downloads.sourceforge.net/tcl/
        md5: aa0a121d95a0e7b73a036f26028538d4
        folder: unix
        commands:
            preparation:
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - TZ=UTC make test
            installation:
                - make install
                - chmod -v u+w /tools/lib/libtcl8.6.so
                - make install-private-headers
                - ln -sv tclsh8.6 /tools/bin/tclsh
    expect:
        description: Expect
        version: 5.45.4
        file: expect{version}
        extension: .tar.gz
        url: https://prdownloads.sourceforge.net/expect/
        md5: 00fce8de158422f5ccd2666512329bd2
        commands:
            preparation:
                - cp -v configure{,.orig}
                - sed 's:/usr/local/bin:/bin:' configure.orig > configure
                - ./configure --prefix=/tools
                              --with-tcl=/tools/lib
                              --with-tclinclude=/tools/include
            compilation:
                - make
            testing:
                - make test
            installation:
                - make SCRIPTS="" install
    dejagnu:
        description: DejaGNU
        version: 1.6.2
        file: dejagnu-{version}
        extension: .tar.gz
        url: http://ftp.gnu.org/gnu/dejagnu/
        md5: e1b07516533f351b3aba3423fafeffd6
        commands:
            preparation:
                - ./configure --prefix=/tools
            installation:
                - make install
            validation:
                - make check
    m4:
        description: M4
        version: 1.4.18
        file: m4-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/m4/
        md5: 730bb15d96fffe47e148d1e09235af82
        commands:
            preparation:
                - sed -i 's/IO_ftrylockfile/IO_EOF_SEEN/' lib/*.c
                - echo "#define _IO_IN_BACKUP 0x100" >> lib/stdio-impl.h
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    ncurses:
        description: Ncurses
        version: 6.1
        file: ncurses-{version}
        extension: .tar.gz
        url: http://ftp.gnu.org/gnu/ncurses/
        md5: 98c889aaf8d23910d2b92d65be2e737a
        commands:
            preparation:
                - sed -i s/mawk// configure
                - ./configure --prefix=/tools
                              --with-shared
                              --without-debug
                              --without-ada
                              --enable-widec
                              --enable-overwrite
            compilation:
                - make
            installation:
                - make install
                - ln -s libncursesw.so /tools/lib/libncurses.so
    bash:
        description: Bash
        version: 5.0
        file: bash-{version}
        extension: .tar.gz
        url: http://ftp.gnu.org/gnu/bash/
        md5: 2b44b47b905be16f45709648f671820b
        commands:
            preparation:
                - ./configure --prefix=/tools
                              --without-bash-malloc
            compilation:
                - make
            testing:
                - make tests
            installation:
                - make install
                - ln -sv bash /tools/bin/sh
    bison:
        description: Bison
        version: 3.3.2
        file: bison-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/bison/
        md5: c9b552dee234b2f6b66e56b27e5234c9
        commands:
            preparation:
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    bzip2:
        description: Bzip2
        version: 1.0.6
        file: bzip2-{version}
        extension: .tar.gz
        url: http://anduin.linuxfromscratch.org/LFS/
        md5: 00b516f4704d4a7cb50a1d97e6e8e15b
        commands:
            compilation:
                - make
            installation:
                - make PREFIX=/tools install
    coreutils:
        description: Coreutils
        version: '8.30'
        file: coreutils-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/coreutils/
        md5: ab06d68949758971fe744db66b572816
        commands:
            preparation:
                - ./configure --prefix=/tools
                              --enable-install-program=hostname
            compilation:
                - make
            testing:
                - make RUN_EXPENSIVE_TESTS=yes check
            installation:
                - make install
    diffutils:
        description: Diffutils
        version: 3.7
        file: diffutils-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/diffutils/
        md5: 4824adc0e95dbbf11dfbdfaad6a1e461
        commands:
            preparation:
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    file:
        description: File
        version: 5.36
        file: file-{version}
        extension: .tar.gz
        url: ftp://ftp.astron.com/pub/file/
        md5: 9af0eb3f5db4ae00fffc37f7b861575c
        commands:
            preparation:
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    findutils:
        description: Findutils
        version: 4.6.0
        file: findutils-{version}
        extension: .tar.gz
        url: http://ftp.gnu.org/gnu/findutils/
        md5: 9936aa8009438ce185bea2694a997fc1
        commands:
            preparation:
                - sed -i 's/IO_ftrylockfile/IO_EOF_SEEN/' gl/lib/*.c
                - "sed -i '/unistd/a #include <sys/sysmacros.h>' gl/lib/mountlist.c"
                - echo "#define _IO_IN_BACKUP 0x100" >> gl/lib/stdio-impl.h
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    gawk:
        description: Gawk
        version: 4.2.1
        file: gawk-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/gawk/
        md5: 95cf553f50ec9f386b5dfcd67f30180a
        commands:
            preparation:
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    gettext:
        description: Gettext
        version: 0.19.8.1
        file: gettext-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/gettext/
        md5: df3f5690eaa30fd228537b00cb7b7590
        commands:
            preparation:
                - ./configure --disable-shared
            compilation:
                - make
            installation:
                - cp -v gettext-tools/src/{msgfmt,msgmerge,xgettext} /tools/bin
    grep:
        description: Grep
        version: 3.3
        file: grep-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/grep/
        md5: 05d0718a1b7cc706a4bdf8115363f1ed
        commands:
            preparation:
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    gzip:
        description: Gzip
        version: 1.10
        file: gzip-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/gzip/
        md5: 691b1221694c3394f1c537df4eee39d3
        commands:
            preparation:
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    make:
        description: Make
        version: 4.2.1
        file: make-{version}
        extension: .tar.bz2
        url: http://ftp.gnu.org/gnu/make/
        md5: 15b012617e7c44c0ed482721629577ac
        commands:
            preparation:
                - sed -i '211,217 d; 219,229 d; 232 d' glob/glob.c
                - ./configure --prefix=/tools
                              --without-guile
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    patch:
        description: Patch
        version: 2.7.6
        file: patch-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/patch/
        md5: 78ad9937e4caadcba1526ef1853730d5
        commands:
            preparation:
                - ./configure --prefix=/tools
            compilation:
                - make
            testing:
                - make check
            installation:
                - make install
    perl:
        description: Perl
        version: 5.28.1
        file: perl-{version}
        extension: .tar.xz
        url: https://www.cpan.org/src/5.0/
        md5: fbb590c305f2f88578f448581b8cf9c4
        commands:
            preparation:
                - sh Configure -des
                               -Dprefix=/tools
                               -Dlibs=-lm
                               -Uloclibpth
                               -Ulocincpth
            compilation:
                - make
            installation:
                - cp -v perl cpan/podlators/scripts/pod2man /tools/bin
                - mkdir -pv /tools/lib/perl5/5.30.0
                - cp -Rv lib/* /tools/lib/perl5/5.30.0
...
