---
# A list of variables that must be set for all elements
preamble:
    LC_ALL: POSIX
    WANDER: /mnt/wander
    PATH: /tools/bin:/bin:/usr/bin
    WANDER_TGT: '{arch}-wander-linux-gnu'
#     LDFLAGS = --sysroot=$WANDER
# The user that must run this section
user: wander
# The elements, each representing one unit to execute
elements:
    binutils_1:
        description: Binutils (Pass 1)
        version: 2.32
        file: binutils-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/binutils/
        md5: 0d174cdaf85721c5723bf52355be41e6
        folder: build
        skip: false
        commands:
            preparation:
                - ../configure --prefix=/tools --with-sysroot=$WANDER --with-lib-path=/tools/lib --target=$WANDER_TGT --disable-nls --disable-werror
            compilation:
                - make
            configuration:
                - case $(uname -m) in x86_64) mkdir -v /tools/lib && ln -sv lib /tools/lib64 ;; esac
            installation:
                - make install
    gcc_1:
        description: GCC (Pass 1)
        version: 9.2.0
        file: gcc-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/gcc/gcc-{version}/
        md5: 3818ad8600447f05349098232c2ddc78
        modules:
            mpfr:
                description: MPFR
                version: 4.0.2
                file: mpfr-{version}
                extension: .tar.xz
                url: http://www.mpfr.org/mpfr-{version}
                md5: 320fbc4463d4c8cb1e566929d8adc4f8
                folder: mpfr
            gmp:
                description: GMP
                version: 6.1.2
                file: gmp-{version}
                extension: .tar.xz
                url: http://ftp.gnu.org/gnu/gmp/
                md5: f58fa8001d60c4c77595fbbb62b63c1d
                folder: gmp
            mpc:
                description: MPC
                version: 1.1.0
                file: mpc-{version}
                extension: .tar.gz
                url: http://ftp.gnu.org/gnu/mpc/
                md5: 4125404e41e482ec68282a2e687f6c73
                folder: mpc
        folder: build
        skip: false
        commands:
            setup:
                - for file in gcc/config/{linux,i386/linux{,64}}.h; do (cp -uv $file{,.orig}; sed -e 's@/lib\(64\)\?\(32\)\?/ld@/tools&@g' -e 's@/usr@/tools@g' $file.orig > $file; printf '#undef STANDARD_STARTFILE_PREFIX_1\n#undef STANDARD_STARTFILE_PREFIX_2\n#define STANDARD_STARTFILE_PREFIX_1 "/tools/lib/"\n#define STANDARD_STARTFILE_PREFIX_2 ""\n' >> $file; touch $file.orig); done
                - case $(uname -m) in x86_64) sed -e '/m64=/s/lib64/lib/' -i.orig gcc/config/i386/t-linux64 ;; esac
            preparation:
                - ../configure --target=$WANDER_TGT --prefix=/tools --with-glibc-version=2.11 --with-sysroot=$WANDER --with-newlib --without-headers --with-local-prefix=/tools --with-native-system-header-dir=/tools/include --disable-nls --disable-shared --disable-multilib --disable-decimal-float --disable-threads --disable-libatomic --disable-libgomp --disable-libquadmath --disable-libssp --disable-libvtv --disable-libstdcxx --enable-languages=c,c++
            compilation:
                - make
            installation:
                - make install
    linux:
        description: Linux API Headers
        version: 5.2.8
        file: linux-{version}
        extension: .tar.xz
        url: http://www.kernel.org/pub/linux/kernel/v5.x/
        md5: 602dd0ecb8646e539fefb2beb6eb6fe0
        skip: false
        commands:
            preparation:
                - make mrproper
            installation:
                - make INSTALL_HDR_PATH=dest headers_install
                - cp -rv dest/include/* /tools/include
    glibc:
        description: Glibc
        version: '2.30'
        file: glibc-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/glibc/
        md5: 2b1dbdf27b28620752956c061d62f60c
        folder: build
        skip: false
        commands:
            preparation:
                - ../configure --prefix=/tools --host=$WANDER_TGT --build=$(../scripts/config.guess) --enable-kernel=3.2 --with-headers=/tools/include
            compilation:
                - make
            installation:
                - make install
            testing:
                - echo 'int main(){}' > dummy.c
                - $WANDER_TGT-gcc dummy.c
                - "readelf -l a.out | grep ': /tools'"
            cleanup:
                - rm -v dummy.c a.out
        test:
            - "[Requesting program interpreter: /tools/lib64/ld-linux-x86-64.so.2]"
            - "[Requesting program interpreter: /tools/lib/ld-linux.so.2]"
    libstdc++:
        description: Libstdc++ (from GCC)
        version: 9.2.0
        file: gcc-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/gcc/gcc-{version}/
        md5: 3818ad8600447f05349098232c2ddc78
        folder: build
        skip: false
        commands:
            preparation:
                - ../libstdc++-v3/configure --host=$WANDER_TGT --prefix=/tools --disable-multilib --disable-nls --disable-libstdcxx-threads --disable-libstdcxx-pch --with-gxx-include-dir=/tools/$WANDER_TGT/include/c++/9.2.0
            compilation:
                - make
            installation:
                - make install
    binutils_2:
        description: Binutils (Pass 2)
        version: 2.32
        file: binutils-{version}
        extension: .tar.xz
        url: http://ftp.gnu.org/gnu/binutils/
        md5: 0d174cdaf85721c5723bf52355be41e6
        folder: build
        skip: false
        commands:
            preparation:
                - CC=$WANDER_TGT-gcc AR=$WANDER_TGT-ar RANLIB=$WANDER_TGT-ranlib ../configure --prefix=/tools --disable-nls --disable-werror --with-lib-path=/tools/lib --with-sysroot
            compilation:
                - make
            installation:
                - make install
            cleanup:
                - make -C ld clean
                - "make -C ld LIB_PATH=/usr/lib:/lib"
                - cp -v ld/ld-new /tools/bin
...
